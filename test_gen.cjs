const { GoogleGenerativeAI, SchemaType } = require("@google/generative-ai");
const fs = require('fs');
const Papa = require('papaparse');

let apiKey;
try {
    const envFile = fs.readFileSync('./.env', 'utf8');
    const match = envFile.match(/VITE_GEMINI_API_KEY=(.*)/);
    if (match) apiKey = match[1].trim();
} catch (e) {
    console.error("Could not read .env file");
}

if (!apiKey) {
    console.error("API Key not found in .env");
    process.exit(1);
}

const genAI = new GoogleGenerativeAI(apiKey);
const model = genAI.getGenerativeModel({
    model: "gemini-2.5-flash-lite",
    generationConfig: {
        responseMimeType: "application/json",
        maxOutputTokens: 10000,
        responseSchema: {
            type: SchemaType.OBJECT,
            properties: {
                recommended_track: {
                    type: SchemaType.ARRAY,
                    items: {
                        type: SchemaType.OBJECT,
                        properties: {
                            grade: { type: SchemaType.STRING },
                            activities: {
                                type: SchemaType.ARRAY,
                                items: { type: SchemaType.STRING }
                            },
                            courses: {
                                type: SchemaType.ARRAY,
                                items: { type: SchemaType.STRING }
                            }
                        },
                        required: ["grade", "activities", "courses"]
                    }
                },
                strategy: {
                    type: SchemaType.STRING
                }
            },
            required: ["recommended_track", "strategy"]
        }
    }
});

async function main() {
    // Read Data
    const csvContent = fs.readFileSync('./primary_data/programs.csv', 'utf8');
    const curriculumData = JSON.parse(fs.readFileSync('./primary_data/curriculum.json', 'utf8'));

    const parsedCsv = Papa.parse(csvContent, { header: true, skipEmptyLines: true });
    const programData = parsedCsv.data;

    // User Data
    const userData = {
        name: "TestStudent",
        interest: "ì˜ì–´êµì‚¬",
        style: "activity"
    };

    const systemInstruction = `ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ìµœê³ ì˜ ì§„ë¡œ ì§„í•™ ì „ë¬¸ê°€ì´ì êµìœ¡ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.
í•™ìƒì˜ ì§„ë¡œì™€ ì„±í–¥ì„ ë¶„ì„í•˜ì—¬, ë‹¨ìˆœí•œ ë‚˜ì—´ì´ ì•„ë‹Œ 'í•œ í¸ì˜ ì„±ì¥ ì„œì‚¬(Storytelling)'ê°€ ë‹´ê¸´ 3ê°œë…„ ë¡œë“œë§µì„ ì„¤ê³„í•˜ì‹­ì‹œì˜¤.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ [í•„ìˆ˜] ì „ë¬¸ê°€ ì „ëµ(strategy) ì‘ì„± í…œí”Œë¦¿ (Markdown ì‚¬ìš©)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë‹¤ìŒ êµ¬ì¡°ë¥¼ ë°˜ë“œì‹œ ì¤€ìˆ˜í•˜ì—¬ strategy í•„ë“œë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

# ğŸš€ 3ë…„ê°„ì˜ ì„±ì¥ ë¡œë“œë§µ: [í•™ìƒì´ë¦„]ì˜ ì ì¬ë ¥ì„ ê¹¨ìš°ë‹¤

## 1í•™ë…„: [ì „ê³µ]ì˜ ì§„ì§œ ì¬ë¯¸ë¥¼ ë°œê²¬í•˜ëŠ” ì‹œê¸°
- **í•µì‹¬ ëª©í‘œ**: "ì™œ ì´ ê³µë¶€ê°€ ì¬ë°Œì„ê¹Œ?"ë¼ëŠ” ì§ˆë¬¸ì— ë‹µì„ ì°¾ëŠ” ê³¼ì •
- **í™œë™ ê°€ì´ë“œ**: ì •ë‹µì„ ë§íˆëŠ” ê³µë¶€ê°€ ì•„ë‹ˆë¼, ì—‰ëš±í•œ ì§ˆë¬¸ì„ ë˜ì§€ëŠ” íƒêµ¬(ì°½ì˜ìº í”„, ë…ì„œ)ì— ì§‘ì¤‘í•˜ì„¸ìš”.

## 2í•™ë…„: ì´ë¡ ì„ í˜„ì‹¤ì— ì ìš©í•˜ëŠ” ì‹œê¸° (Deep Dive)
- **í•µì‹¬ ëª©í‘œ**: ë°°ìš´ ì§€ì‹ì„ ë„êµ¬ë¡œ ì‚¼ì•„ ì„¸ìƒì˜ ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ê¸°
- **ì¶”ì²œ í™œë™**: [ë°ì´í„°ê³¼í•™ í•´ì»¤í†¤/R&E] ë“±ì„ í†µí•´ "ë‚´ ì§€ì‹ì´ ì´ë ‡ê²Œ ì“°ì¼ ìˆ˜ ìˆêµ¬ë‚˜"ë¥¼ ê²½í—˜í•˜ì„¸ìš”.
- **ì—°êµ¬ ì œì•ˆ**: ${userData.interest}ì™€ ê´€ë ¨ëœ êµ¬ì²´ì ì¸ íƒêµ¬ ì£¼ì œ(ì˜ˆ: ~ì— ëŒ€í•œ í†µê³„ì  ë¶„ì„)ë¥¼ í•˜ë‚˜ ì •í•´ì„œ ê¹Šê²Œ íŒŒê³ ë“œì„¸ìš”.

## 3í•™ë…„: ëŒ€í•™ [ì „ê³µ]ì˜ ë¬¸ì„ ë¯¸ë¦¬ ì—¬ëŠ” ì‹œê¸°
- **í•µì‹¬ ëª©í‘œ**: ê³ êµ ìˆ˜ì¤€ì„ ë„˜ì–´ì„  ì „ë¬¸ì„± ì¦ëª…
- **ì‹¬í™” í•™ìŠµ**: ê³µë™êµìœ¡ê³¼ì •([ê³¼ëª©ëª…])ì´ë‚˜ ì‹¬í™” ì£¼ì œíƒêµ¬ë¥¼ í†µí•´ ëŒ€í•™ 1í•™ë…„ ìˆ˜ì¤€ì˜ í•™ì—… ì—­ëŸ‰ì„ ë³´ì—¬ì£¼ì„¸ìš”.

### ğŸ’¡ ì»¨ì„¤í„´íŠ¸ì˜ ì´í‰
ì´ íŠ¸ë™ì„ ë”°ë¼ê°„ë‹¤ë©´, ë‹¨ìˆœíˆ ëŒ€í•™ì„ ì˜ ê°€ëŠ” ê²ƒì„ ë„˜ì–´ [ì „ê³µ] ë¶„ì•¼ì˜ ë¯¿ìŒì§í•œ ì¸ì¬ë¡œ ì„±ì¥í•  ê²ƒì…ë‹ˆë‹¤.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš¨ í”„ë¡œê·¸ë¨ ì¶”ì²œ ì‹œ ì ˆëŒ€ ê·œì¹™
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. **[ë¶„ê³¼ ëª…ì¹­ ì¤€ìˆ˜]**: 'ì§€ì—­ê³¼ í•¨ê»˜í•˜ëŠ” ê¹Šì´ìˆëŠ” ì²´í—˜í™œë™'ì€ ë°˜ë“œì‹œ ì•„ë˜ 7ê°œ ë¶„ê³¼ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ëª…ì‹œí•˜ì‹­ì‹œì˜¤. (ì˜ˆ: ì§€ì—­ê³¼ í•¨ê»˜í•˜ëŠ” ê¹Šì´ìˆëŠ” ì²´í—˜í™œë™(AIìœµí•©))
   - [ê°€ìš© ë¶„ê³¼]: ì´ì°¨ì „ì§€, ê¸°ê³„ê³µí•™, AIìœµí•©, ì§€ì†ê°€ëŠ¥ë°œì „, ì§€ì—­ì—­ì‚¬ ë¬¸í™”ê²½ì œ, ìš°ì£¼ê³¼í•™(ë‚˜ë¡œí˜¸ ë“±), ê³µê°„ ì˜ˆìˆ /ê±´ì¶•

2. **[ëŒ€ìƒ í•™ë…„ ì—„ìˆ˜]**: 
   - ì œê³µëœ í”„ë¡œê·¸ë¨ ë°ì´í„°ì˜ "ëŒ€ìƒí•™ë…„"ì„ ë°˜ë“œì‹œ í™•ì¸í•˜ì‹­ì‹œì˜¤.
   - 1í•™ë…„ì—ê²Œ 3í•™ë…„ ì „ìš© í”„ë¡œê·¸ë¨(ì˜ˆ: ì‹¬í™” ê³µë™êµìœ¡ê³¼ì •)ì„ ì¶”ì²œí•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
   - 3í•™ë…„ì—ê²ŒëŠ” ìˆ˜ëŠ¥ ì¤€ë¹„ì— ë°©í•´ë˜ì§€ ì•Šë„ë¡ 1í•™ê¸° ìœ„ì£¼ë¡œ ë°°ì¹˜í•˜ì‹­ì‹œì˜¤.

3. **[ì„±í–¥ ë°˜ì˜]**:
   - **íƒêµ¬ëª°ì…í˜•**: ë‹¤ì–‘í•œ ìº í”„, í”„ë¡œì íŠ¸, R&E ìœ„ì£¼ (í•™ê¸°ë‹¹ 4~5ê°œ)
   - **í•™ì—…ì§‘ì¤‘í˜•**: ë‚´ì‹ /ìˆ˜ëŠ¥ ê³µë¶€ì™€ ì‹œë„ˆì§€ ë‚˜ëŠ” í™œë™ ìœ„ì£¼ (í•™ê¸°ë‹¹ 2~3ê°œ)

4. **[ëª…ì¹­ ì •ì œ]**:
   - í”„ë¡œê·¸ë¨ëª…ì— í¬í•¨ëœ ì§€ì €ë¶„í•œ ë¶€ê°€ ì„¤ëª…(ìš´ì˜ ì‹œê¸° ë“±)ì€ ì œì™¸í•˜ê³  ê¹”ë”í•œ ëª…ì¹­ë§Œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.
`;

    const prompt = `
[í•™ìƒ ì •ë³´]
ì´ë¦„: ${userData.name}
í¬ë§ì§„ë¡œ: ${userData.interest}
ì„±í–¥: ${userData.style === 'activity' ? 'íƒêµ¬ëª°ì…í˜•' : 'í•™ì—…ì§‘ì¤‘í˜•'}

[í•™êµ í”„ë¡œê·¸ë¨ ë°ì´í„°]
${JSON.stringify(programData.map(p => ({
        ì´ë¦„: p["í”„ë¡œê·¸ë¨ëª…"],
        ëŒ€ìƒí•™ë…„: p["ëŒ€ìƒí•™ë…„"],
        íŠ¹ì´ì‚¬í•­: p["íŠ¹ì´ì‚¬í•­"] || ""
    })))}

[êµìœ¡ê³¼ì • ë°ì´í„°]
${JSON.stringify(curriculumData)}

ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ JSON í˜•ì‹ì˜ ì¶”ì²œ íŠ¸ë™ì„ ìƒì„±í•˜ì‹­ì‹œì˜¤.
`;

    try {
        const result = await model.generateContent([systemInstruction, prompt]);
        const text = result.response.text();
        fs.writeFileSync('output_result.json', text);
        console.log("Output written to output_result.json");
    } catch (e) {
        console.error(e);
    }
}

main();
